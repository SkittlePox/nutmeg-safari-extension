<!DOCTYPE html>
<html>

<head>
</head>

<body>
    <script>
        var Node = function(url, title, childrenURLs, firstVisit, lastVisit) {
            this.url = url;
            this.title = title;
            this.childrenURLs = childrenURLs;
            this.firstVisit = firstVisit;
            this.lastVisit = lastVisit;
        }

        var db;
        connect2DB(); // Establish connection to database: assign to variable db

        safari.application.addEventListener("message", navNodeIncoming, false);
        safari.application.addEventListener("navigate", visitUpdate, true);

        function connect2DB() {
            var openRequest = indexedDB.open("nutmeg-shed", 2);

            openRequest.onupgradeneeded = function(e) {
                var thisDB = e.target.result;

                if (!thisDB.objectStoreNames.contains("all-browsing")) {
                    var os = thisDB.createObjectStore("all-browsing", {
                        keyPath: "url",
                        autoIncrement: true
                    });
                }
            }
            openRequest.onsuccess = function(e) {
                db = e.target.result;
            }
            openRequest.onerror = function(e) {
                console.log("openRequest error!");
                console.dir(e);
            }
        }

        function navNodeIncoming(msg) {
            if (msg.name != "newNode") return;
            navNode = msg.message;

            var store = db.transaction([navNode.objStore], "readwrite").objectStore(navNode.objStore); // Access object store
            var fetchNodeRequest = store.get(navNode.parentURL);

            fetchNodeRequest.onsuccess = function() {
                var fetchedNode = fetchNodeRequest.result;
                if (fetchedNode) {
                    if (fetchedNode.childrenURLs.indexOf(navNode.childURL) == -1) { // If the URL is not already in the fetched node's child URL list
                        fetchedNode.childrenURLs.push(navNode.childURL);
                        store.put(fetchedNode);
                        store.add(new Node(navNode.childURL, null, [], new Date(), new Date())); // Bounces if the entry already exists
                    }
                } else {
                    store.add(new Node(navNode.parentURL, navNode.parentTitle, [navNode.childURL], navNode.visitTime, navNode.visitTime));
                    store.add(new Node(navNode.childURL, null, [], navNode.visitTime, navNode.visitTime)); // Bounces if the entry already exists
                }
            }
        }

        function visitUpdate(e) { // Updates database upon page visit
            var store = db.transaction(["all-browsing"], "readwrite").objectStore("all-browsing"); // Access object store
            var fetchNodeRequest = store.get(e.target.url);

            fetchNodeRequest.onsuccess = function() {
                var fetchedNode = fetchNodeRequest.result;
                if (fetchedNode) {
                    fetchedNode.title = e.target.title;
                    fetchedNode.lastVisit = new Date();
                    var updateRequest = store.put(fetchedNode);
                }
            }
        }

        //TODO Child check in parent node so no recursion - use time stamp
    </script>
</body>

</html>
